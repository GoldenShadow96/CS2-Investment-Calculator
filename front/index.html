<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Steam ⇄ DMarket Cycle Calculator</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; background: #f4f4f4; padding: 2rem }
    .container { max-width: 760px; margin: auto; background: #fff; padding: 2rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,.08) }
    label { display: block; margin-top: 1rem; font-weight: 600 }
    input { width: 100%; padding: .5rem; margin-top: .25rem; border: 1px solid #ccc; border-radius: 4px }
    button { margin-top: 1rem; padding: .6rem 1.4rem; border: none; border-radius: 5px; background: #0e6efd; color: #fff; font-weight: 600; cursor: pointer }
    button:hover { opacity: .9 }
    .metric { margin-top: .8rem; font-weight: 700 }
    .pos { color: #218739 } .neg { color: #c41111 }
    ul { list-style: none; padding: 0; margin-top: 1rem }
    li { padding: .6rem; border: 1px solid #ddd; border-radius: 5px; margin-bottom: .5rem; background: #fafafa; font-size: .9rem }
    .btn { margin-left: 8px; padding: .25rem .5rem; border: none; border-radius: 3px; cursor: pointer }
    .del { background: #c41111; color: #fff } .ign { background: #e2b400; color: #000 }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
  <h2>Steam ⇄ DMarket Cycle Calculator</h2>

  <label for="psin">Cena zakupu na Steam – P<sub>s,in</sub> [zł]</label>
  <input type="number" id="psin" step="0.01" placeholder="np. 100.00">

  <label for="pd">Cena sprzedaży na DMarket – P<sub>d</sub> [zł]</label>
  <input type="number" id="pd" step="0.01" placeholder="np. 97.00">

  <label for="ps">Cena sprzedaży na Steam – P<sub>s</sub> [zł]</label>
  <input type="number" id="ps" step="0.01" placeholder="np. 126.00">

  <button onclick="calc()">Oblicz cykl</button>

  <div id="metrics"></div>

  <h3>Historia</h3>
  <ul id="history"></ul>

  <h3>Wykres danych transakcji</h3>
  <canvas id="chart" height="160"></canvas>
</div>

<script>
const API = 'http://localhost:5000';

const metrics = document.getElementById('metrics');
const history = document.getElementById('history');

function fmt(n){ return Number(n).toFixed(2); }

async function load(){
  try {
    const r = await fetch(`${API}/transactions`);
    const data = await r.json();
    renderHistory(data);
  } catch (e) {
    history.innerHTML = '<li>Backend not available…</li>';
  }
}

function renderHistory(arr){
  history.innerHTML = '';
  arr.forEach((tx,i)=>{
    const li = document.createElement('li');
    li.innerHTML =
      `Zysk: <strong class="${tx.profit > 0 ? 'pos' : 'neg'}">${fmt(tx.profit)} zł</strong> | ROI: ${fmt(tx.roi)} %` +
      ` | P<sub>s,in</sub>: ${fmt(tx.Psin)} | P<sub>s</sub>: ${fmt(tx.Ps)} | P<sub>d</sub>: ${fmt(tx.Pd)}` +
      (tx.ignored ? ' (ignored)' : '');
    const del = document.createElement('button');
    del.textContent = 'del'; del.className = 'btn del';
    del.onclick = () => update(i, 'DELETE');
    const ign = document.createElement('button');
    ign.textContent = tx.ignored ? 'unignore' : 'ignore'; ign.className = 'btn ign';
    ign.onclick = () => update(i, 'TOGGLE');
    li.appendChild(ign); li.appendChild(del);
    history.appendChild(li);
  });
  renderContextualChart(arr);
}

async function update(idx, act){
  if (act === 'DELETE')
    await fetch(`${API}/transactions/${idx}`, { method: 'DELETE' });
  else
    await fetch(`${API}/transactions/${idx}`, {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ ignored: false })
    });
  load();
}

async function calc() {
  const Ps = parseFloat(document.getElementById('ps').value);
  const Pd = parseFloat(document.getElementById('pd').value);
  const Psin = parseFloat(document.getElementById('psin').value);

  if ([Ps, Pd, Psin].some(isNaN)) {
    metrics.textContent = 'Uzupełnij wszystkie pola.';
    return;
  }

  const Ld = Pd / Psin;
  const profit = Ps * 0.87 - (Pd / Ld);
  const roi = (profit / (Pd / Ld)) * 100;
  const pMin = Pd / 0.87;

  metrics.innerHTML =
    `<div class="metric">Zysk: <span class="${profit >= 0 ? 'pos' : 'neg'}">${fmt(profit)} zł</span> &nbsp;|&nbsp; ROI: ${fmt(roi)} %</div>` +
    `<div class="metric">Minimalne P<sub>s</sub> dla break-even: ${fmt(pMin)} zł</div>`;

  const tx = { Ps, Pd, Psin, Ld, profit, roi, ignored: false };

  try {
    await fetch(`${API}/transactions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(tx)
    });
    load();
  } catch (e) {}
}

function renderContextualChart(data) {
  const filtered = data.filter(tx => !tx.ignored);
  const labels = filtered.map((_, i) => `#${i + 1}`);
  const PSin = filtered.map(tx => -tx.Psin);
  const Pd = filtered.map(tx => -tx.Pd);
  const PsNet = filtered.map(tx => 0.87 * tx.Ps);
  const profit = filtered.map(tx => tx.profit);
  const roi = filtered.map(tx => tx.roi);

  const ctx = document.getElementById("chart").getContext("2d");
  if (window.myChart) window.myChart.destroy();

  window.myChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: "Zakup Steam (P_s,in)",
          data: PSin,
          backgroundColor: "#c41111",
          yAxisID: "y",
          stack: 'stack1',
          barPercentage: 0.1,
          categoryPercentage: 1.0,
          order: 3,
        },
        {
          label: "Sprzedaż DMarket (P_d)",
          data: Pd,
          backgroundColor: "#888888",
          yAxisID: "y",
          stack: 'stack1',
          barPercentage: 0.1,
          categoryPercentage: 1.0,
          order: 2,
        },
        {
          label: "Sprzedaż Steam netto (0.87 × P_s)",
          data: PsNet,
          backgroundColor: "#218739",
          yAxisID: "y",
          stack: 'stack1',
          order: 1,
          barPercentage: 0.1,
          categoryPercentage: 1.0,
        },
        {
          type: "line",
          label: "Zysk",
          data: profit.map((p, i) => ({ x: labels[i], y: p })),
          backgroundColor: "#e2b400",
          borderColor: "#e2b400",
          pointStyle: "circle",
          pointRadius: 5,
          yAxisID: "y",
          order: 0,
          showLine: false
        },
        {
          type: "scatter",
          label: "ROI (%)",
          data: roi,
          borderColor: "#555",
          backgroundColor: "#555",
          order: 0,
          yAxisID: "y1"
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "top" },
        tooltip: { mode: "index", intersect: false }
      },
      interaction: { mode: "index", intersect: false },
      scales: {
        y: {
          beginAtZero: true,
          stacked: false,
          title: { display: true, text: "Kwota (zł)" }
        },
        y1: {
          beginAtZero: true,
          position: "right",
          title: { display: true, text: "ROI (%)" },
          grid: { drawOnChartArea: false }
        },
        x: {
          stacked: true
        }
      }
    }
  });
}


load();
</script>
</body>
</html>
